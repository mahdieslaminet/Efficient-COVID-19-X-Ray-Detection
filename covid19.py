# -*- coding: utf-8 -*-
"""Covid19.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/12TmpbwAAriM9b1eJ5dndJpQWNuL9QiC-
"""

from google.colab import drive
drive.mount('/content/drive')

import tensorflow.compat.v1 as tf
tf.disable_v2_behavior()

import cv2
import numpy as np
import os
import pandas as pd
from IPython.display import display

# ===============================
# Ù…Ø³ÛŒØ±Ù‡Ø§
# ===============================
model_dir = "/content/drive/MyDrive/COVID_Model"
image_dir = "/content"

# ØªØ±ØªÛŒØ¨ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§
labels = ['Normal', 'COVID-19', 'Pneumonia']

# ===============================
# Ø±ÛŒØ³Øª Ùˆ Ø³Ø´Ù†
# ===============================
tf.reset_default_graph()
sess = tf.Session()

# ===============================
# Ù„ÙˆØ¯ Ù…Ø¯Ù„
# ===============================
meta_path = os.path.join(model_dir, "model .meta")
saver = tf.train.import_meta_graph(meta_path)
saver.restore(sess, os.path.join(model_dir, "model"))
graph = tf.get_default_graph()

# ===============================
# Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ùˆ Ø®Ø±ÙˆØ¬ÛŒ
# ===============================
input_256 = graph.get_tensor_by_name("input_1:0")
input_480 = graph.get_tensor_by_name("input_2:0")
softmax_tensor = [op.outputs[0] for op in graph.get_operations() if "Softmax" in op.name][-1]

# ===============================
# Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµØ§ÙˆÛŒØ±
# ===============================
image_files = [f for f in os.listdir(image_dir) if f.lower().endswith(('.png','.jpg','.jpeg'))]

results = []
correct = 0

for img_name in image_files:
    img_path = os.path.join(image_dir, img_name)
    img = cv2.imread(img_path)
    if img is None:
        continue

    # -------- Ù„ÛŒØ¨Ù„ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Ø§Ø³Ù… ÙØ§ÛŒÙ„ --------
    name = img_name.lower()
    if "covid" in name:
        actual = "COVID-19"
    elif "pneumonia" in name:
        actual = "Pneumonia"
    elif "normal" in name:
        actual = "Normal"
    else:
        actual = "Unknown"

    # -------- Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø²Ø´ --------
    gray_256 = cv2.resize(cv2.cvtColor(img, cv2.COLOR_BGR2GRAY), (256,256))
    gray_256 = gray_256.astype(np.float32)/255.0
    gray_256 = np.expand_dims(gray_256, axis=(0,-1))

    rgb_480 = cv2.resize(cv2.cvtColor(img, cv2.COLOR_BGR2RGB), (480,480))
    rgb_480 = rgb_480.astype(np.float32)/255.0
    rgb_480 = np.expand_dims(rgb_480, axis=0)

    # -------- Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¯Ù„ --------
    preds = sess.run(
        softmax_tensor,
        feed_dict={
            input_256: gray_256,
            input_480: rgb_480
        }
    )[0]

    pred_label = labels[np.argmax(preds)]
    confidence = np.max(preds) * 100

    is_correct = (pred_label == actual)
    if is_correct:
        correct += 1

    results.append({
        "Ù†Ø§Ù… ÙØ§ÛŒÙ„": img_name,
        "Ø¬ÙˆØ§Ø¨ ÙˆØ§Ù‚Ø¹ÛŒ": actual,
        "ØªØ´Ø®ÛŒØµ Ù…Ø¯Ù„": pred_label,
        "Ø§Ø·Ù…ÛŒÙ†Ø§Ù†": f"{confidence:.2f}%",
        "ÙˆØ¶Ø¹ÛŒØª": "âœ… Ø¯Ø±Ø³Øª" if is_correct else "âŒ ØºÙ„Ø·"
    })

# ===============================
# Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
# ===============================
df = pd.DataFrame(results)
display(df)

accuracy = (correct / len(results)) * 100
print("\n" + "="*30)
print(f"ğŸ“Š Ø¯Ù‚Øª Ú©Ù„ Ù…Ø¯Ù„: {accuracy:.2f}%")
print(f"âœ… Ø¯Ø±Ø³Øª: {correct}")
print(f"âŒ ØºÙ„Ø·: {len(results)-correct}")
print("="*30)